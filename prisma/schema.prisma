// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =====================================================
// ENUMS
// =====================================================

enum UserRole {
  propietario
  operador
  admin
}

enum AppointmentStatus {
  programada
  confirmada
  en_progreso
  completada
  cancelada
  no_asistio
}

// =====================================================
// MODELOS
// =====================================================

model User {
  id                  String       @id @db.Uuid
  correo              String       @unique @db.VarChar(255)
  nombreCompleto      String       @db.VarChar(255)
  telefono            String?      @db.VarChar(20)
  rol                 UserRole     @default(propietario)
  veterinariaId       String?      @db.Uuid
  estaActivo          Boolean      @default(true)
  creadoEn            DateTime     @default(now()) @db.Timestamptz(6)
  actualizadoEn       DateTime     @updatedAt @db.Timestamptz(6)

  veterinaria         Veterinary?  @relation(fields: [veterinariaId], references: [id])
  propietario         Owner?
  operador            Operator?
  citasCreadas        Appointment[] @relation("CreatedBy")

  @@map("users")
  @@index([rol])
  @@index([veterinariaId])
}

model Veterinary {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  nombre        String    @db.VarChar(255)
  correo        String    @unique @db.VarChar(255)
  telefono      String?   @db.VarChar(20)
  direccion     String?
  ciudad        String?   @db.VarChar(100)
  estado        String?   @db.VarChar(100)
  pais          String    @default("Rep√∫blica Dominicana") @db.VarChar(100)
  codigoPostal  String?   @db.VarChar(20)
  urlLogo       String?
  horarioNegocio Json?
  estaActivo    Boolean   @default(true)
  creadoEn      DateTime  @default(now()) @db.Timestamptz(6)
  actualizadoEn DateTime  @updatedAt @db.Timestamptz(6)

  usuarios          User[]
  propietarios      Owner[]
  operadores        Operator[]
  pacientes         Patient[]
  citas             Appointment[]
  registrosClinico  ClinicalRecord[]
  registrosActividad ActivityLog[]

  @@map("veterinaries")
}

model Owner {
  id                           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  usuarioId                    String    @unique @db.Uuid
  veterinariaId                String?   @db.Uuid
  direccion                    String?
  ciudad                       String?   @db.VarChar(100)
  nombreContactoEmergencia     String?   @db.VarChar(255)
  telefonoContactoEmergencia   String?   @db.VarChar(20)
  notas                        String?
  creadoEn                     DateTime  @default(now()) @db.Timestamptz(6)
  actualizadoEn                DateTime  @updatedAt @db.Timestamptz(6)

  usuario            User          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  veterinaria        Veterinary?   @relation(fields: [veterinariaId], references: [id])
  pacientes          Patient[]
  citas              Appointment[]
  recordatoriosCorreo EmailReminder[]

  @@map("owners")
  @@index([usuarioId])
}

model Operator {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  usuarioId        String    @unique @db.Uuid
  veterinariaId    String    @db.Uuid
  posicion         String?   @db.VarChar(100)
  fechaContratacion DateTime? @db.Date
  estaActivo       Boolean   @default(true)
  permisos         Json?
  creadoEn         DateTime  @default(now()) @db.Timestamptz(6)
  actualizadoEn    DateTime  @updatedAt @db.Timestamptz(6)

  usuario          User              @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  veterinaria      Veterinary        @relation(fields: [veterinariaId], references: [id])
  citas            Appointment[]
  procedimientos   Procedure[]
  registrosClinico ClinicalRecord[]  @relation("RecordedBy")
  vacunaciones     Vaccination[]

  @@map("operators")
  @@index([usuarioId])
}

model Species {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  nombre      String    @unique @db.VarChar(100)
  descripcion String?
  estaActivo  Boolean   @default(true)
  creadoEn    DateTime  @default(now()) @db.Timestamptz(6)
  actualizadoEn DateTime @updatedAt @db.Timestamptz(6)

  razas     Breed[]
  pacientes Patient[]

  @@map("species")
}

model Breed {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  especieId   String   @db.Uuid
  nombre      String   @db.VarChar(100)
  descripcion String?
  estaActivo  Boolean  @default(true)
  creadoEn    DateTime @default(now()) @db.Timestamptz(6)
  actualizadoEn DateTime @updatedAt @db.Timestamptz(6)

  especie   Species   @relation(fields: [especieId], references: [id])
  pacientes Patient[]

  @@unique([especieId, nombre])
  @@map("breeds")
  @@index([especieId])
}

model Patient {
  id                  String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  propietarioId       String    @db.Uuid
  veterinariaId       String?   @db.Uuid
  nombre              String    @db.VarChar(255)
  especieId           String    @db.Uuid
  razaId              String?   @db.Uuid
  color               String?   @db.VarChar(100)
  fechaNacimiento     DateTime? @db.Date
  genero              String?   @db.VarChar(20)
  peso                Decimal?  @db.Decimal(10, 2)
  urlFoto             String?
  numeroMicrochip     String?   @db.VarChar(50)
  estaCastrado        Boolean   @default(false)
  alergias            String?
  condicionesEspeciales String?
  estaActivo          Boolean   @default(true)
  creadoEn            DateTime  @default(now()) @db.Timestamptz(6)
  actualizadoEn       DateTime  @updatedAt @db.Timestamptz(6)

  propietario      Owner             @relation(fields: [propietarioId], references: [id], onDelete: Cascade)
  veterinaria      Veterinary?       @relation(fields: [veterinariaId], references: [id])
  especie          Species           @relation(fields: [especieId], references: [id])
  raza             Breed?            @relation(fields: [razaId], references: [id])
  citas            Appointment[]
  registrosClinico ClinicalRecord[]
  vacunaciones     Vaccination[]

  @@map("patients")
  @@index([propietarioId])
  @@index([especieId])
  @@index([razaId])
}

model Appointment {
  id                      String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  pacienteId              String            @db.Uuid
  propietarioId           String?           @db.Uuid
  veterinariaId           String?           @db.Uuid
  operadorId              String?           @db.Uuid
  fechaHora               DateTime          @db.Timestamptz(6)
  duracionMinutos         Int               @default(30)
  estado                  AppointmentStatus @default(programada)
  tipoCita                String?           @db.VarChar(100)
  motivo                  String
  notas                   String?
  idEventoGoogleCalendar  String?           @db.VarChar(255)
  recordatorioEnviado     Boolean           @default(false)
  recordatorioEnviadoEn   DateTime?         @db.Timestamptz(6)
  canceladoEn             DateTime?         @db.Timestamptz(6)
  motivoCancelacion       String?
  creadoPor               String?           @db.Uuid
  creadoEn                DateTime          @default(now()) @db.Timestamptz(6)
  actualizadoEn           DateTime          @updatedAt @db.Timestamptz(6)

  paciente           Patient           @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  propietario        Owner?            @relation(fields: [propietarioId], references: [id])
  veterinaria        Veterinary?       @relation(fields: [veterinariaId], references: [id])
  operador           Operator?         @relation(fields: [operadorId], references: [id])
  creador            User?             @relation("CreatedBy", fields: [creadoPor], references: [id])
  procedimientos     Procedure[]
  registrosClinico   ClinicalRecord[]
  recordatoriosCorreo EmailReminder[]

  @@map("appointments")
  @@index([pacienteId])
  @@index([propietarioId])
  @@index([fechaHora])
  @@index([estado])
}

model Procedure {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  citaId          String    @db.Uuid
  nombre          String    @db.VarChar(255)
  descripcion     String?
  costo           Decimal?  @db.Decimal(10, 2)
  duracionMinutos Int?
  realizadoPor    String?   @db.Uuid
  realizadoEn     DateTime  @default(now()) @db.Timestamptz(6)
  creadoEn        DateTime  @default(now()) @db.Timestamptz(6)

  cita     Appointment @relation(fields: [citaId], references: [id], onDelete: Cascade)
  ejecutor Operator?   @relation(fields: [realizadoPor], references: [id])

  @@map("procedures")
}

model ClinicalRecord {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  pacienteId            String    @db.Uuid
  citaId                String?   @db.Uuid
  veterinariaId         String?   @db.Uuid
  registradoPor         String?   @db.Uuid
  tipoRegistro          String?   @db.VarChar(50)
  diagnostico           String?
  sintomas              String?
  tratamiento           String?
  medicamentos          Json?
  resultadosLaboratorio Json?
  imagenes              Json?
  observaciones         String?
  fechaSeguimiento      DateTime? @db.Date
  creadoEn              DateTime  @default(now()) @db.Timestamptz(6)
  actualizadoEn         DateTime  @updatedAt @db.Timestamptz(6)

  paciente     Patient       @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  cita         Appointment?  @relation(fields: [citaId], references: [id])
  veterinaria  Veterinary?   @relation(fields: [veterinariaId], references: [id])
  registrador  Operator?     @relation("RecordedBy", fields: [registradoPor], references: [id])
  vacunaciones Vaccination[]

  @@map("clinical_records")
  @@index([pacienteId])
}

model Vaccination {
  id                     String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  pacienteId             String    @db.Uuid
  registroClinicoId      String?   @db.Uuid
  nombreVacuna           String    @db.VarChar(255)
  tipoVacuna             String?   @db.VarChar(100)
  numeroLote             String?   @db.VarChar(100)
  fechaAdministracion    DateTime  @db.Date
  proximaFechaVencimiento DateTime? @db.Date
  administradoPor        String?   @db.Uuid
  notas                  String?
  creadoEn               DateTime  @default(now()) @db.Timestamptz(6)

  paciente        Patient         @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  registroClinico ClinicalRecord? @relation(fields: [registroClinicoId], references: [id])
  administrador   Operator?       @relation(fields: [administradoPor], references: [id])

  @@map("vaccinations")
  @@index([pacienteId])
}

model EmailReminder {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  citaId          String    @db.Uuid
  propietarioId   String?   @db.Uuid
  correoDestino   String    @db.VarChar(255)
  asunto          String?   @db.VarChar(255)
  cuerpo          String?
  programadoPara  DateTime  @db.Timestamptz(6)
  enviadoEn       DateTime? @db.Timestamptz(6)
  estado          String    @default("pending") @db.VarChar(50)
  mensajeError    String?
  creadoEn        DateTime  @default(now()) @db.Timestamptz(6)

  cita        Appointment @relation(fields: [citaId], references: [id], onDelete: Cascade)
  propietario Owner?      @relation(fields: [propietarioId], references: [id])

  @@map("email_reminders")
}

model ActivityLog {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  veterinariaId String?   @db.Uuid
  usuarioId     String?   @db.Uuid
  tipoAccion    String    @db.VarChar(50)
  tipoEntidad   String?   @db.VarChar(50)
  entidadId     String?   @db.Uuid
  descripcion   String
  metadatos     Json?
  creadoEn      DateTime  @default(now()) @db.Timestamptz(6)

  veterinaria Veterinary? @relation(fields: [veterinariaId], references: [id])

  @@map("activity_log")
  @@index([veterinariaId])
  @@index([usuarioId])
  @@index([creadoEn(sort: Desc)])
}
